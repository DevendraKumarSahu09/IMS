<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
      <p class="text-gray-600 mt-1">Manage agents, admins, and their assignments</p>
    </div>
    <div class="flex gap-2">
      <button 
        (click)="openAddUserModal()" 
        class="btn btn-primary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Add Agent/Admin
      </button>
          <button
            (click)="loadUsers()"
            class="btn btn-outline"
            [disabled]="loading">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
          </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <div class="text-2xl font-bold text-gray-900">{{ getUserStats().total }}</div>
          <div class="text-sm text-gray-600">Total Users</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <div class="text-2xl font-bold text-gray-900">{{ getUserStats().agents }}</div>
          <div class="text-sm text-gray-600">Agents</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <div class="text-2xl font-bold text-gray-900">{{ getUserStats().admins }}</div>
          <div class="text-sm text-gray-600">Admins</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <div class="text-2xl font-bold text-gray-900">{{ getUserStats().customers }}</div>
          <div class="text-sm text-gray-600">Customers</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
        <div class="relative">
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchChange()"
            placeholder="Search users..."
            class="input input-bordered w-full pr-10">
          <button
            (click)="searchUsers()"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 btn btn-ghost btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
        <select [(ngModel)]="filters.role" (ngModelChange)="onFilterChange()" class="select select-bordered w-full">
          <option value="">All Roles</option>
          <option value="admin">Admin</option>
          <option value="agent">Agent</option>
          <option value="customer">Customer</option>
        </select>
      </div>


      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Actions</label>
        <div class="flex gap-2">
          <button
            (click)="searchUsers()"
            class="btn btn-primary btn-sm flex-1">
            Apply
          </button>
          <button
            (click)="clearFilters()"
            class="btn btn-outline btn-sm">
            Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex justify-center items-center py-12">
    <div class="loading loading-spinner loading-lg"></div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="alert alert-error mb-6">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>{{ error }}</span>
  </div>

  <!-- Bulk Actions -->
  <div *ngIf="selectedUsers.length > 0" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <span class="text-sm font-medium text-blue-900">
          {{ selectedUsers.length }} user(s) selected
        </span>
        <select [(ngModel)]="bulkAction" class="select select-bordered select-sm">
          <option value="">Select Action</option>
          <option value="delete">Delete Selected</option>
        </select>
        <button (click)="performBulkAction()" class="btn btn-primary btn-sm">
          Apply Action
        </button>
      </div>
      <button (click)="selectedUsers = []" class="btn btn-ghost btn-sm">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div *ngIf="!loading && !error" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                [checked]="selectedUsers.length === users.length && users.length > 0"
                (change)="selectAllUsers()"
                class="checkbox checkbox-sm">
            </th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Assigned Claims</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users" class="hover">
            <td>
              <input
                type="checkbox"
                [checked]="isUserSelected(user._id)"
                (change)="selectUser(user._id)"
                class="checkbox checkbox-sm">
            </td>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-10">
                    <span class="text-sm font-medium">{{ user.name.charAt(0).toUpperCase() }}</span>
                  </div>
                </div>
                <div>
                  <div class="font-medium">{{ user.name }}</div>
                  <div class="text-sm text-gray-500">ID: {{ user._id.slice(-8) }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="text-sm">{{ user.email }}</div>
            </td>
            <td>
              <div class="badge" [ngClass]="getRoleColor(user.role)">
                {{ getRoleDisplay(user.role) }}
              </div>
            </td>
            <td>
              <div class="text-sm text-gray-600">
                {{ getUserStats(user).assignedClaims || 0 }}
              </div>
            </td>
            <td>
              <div class="text-sm text-gray-600">
                {{ formatDate(user.createdAt) }}
              </div>
            </td>
            <td>
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                  </svg>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li>
                    <button (click)="editUser(user)" class="text-sm">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                      Edit User
                    </button>
                  </li>
                  <li *ngIf="user.role === 'agent'">
                    <button (click)="assignPolicy(user)" class="text-sm">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      Assign Policy
                    </button>
                  </li>
                  <li *ngIf="user.role === 'agent'">
                    <button (click)="assignClaim(user)" class="text-sm">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                      </svg>
                      Assign Claim
                    </button>
                  </li>
                  <li *ngIf="canDeleteUser(user)" class="text-error">
                    <button (click)="deleteUser(user)" class="text-sm text-error">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                      Delete User
                    </button>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="users.length === 0" class="text-center py-12">
      <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
      </svg>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
      <p class="text-gray-600">Try adjusting your search criteria or create a new user.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="!loading && !error && pagination.pages > 1" class="flex justify-center mt-6">
    <div class="join">
      <button
        (click)="goToPage(pagination.page - 1)"
        [disabled]="pagination.page <= 1"
        class="join-item btn btn-sm">
        Previous
      </button>
      
      <button
        *ngFor="let page of getTotalPages()"
        (click)="goToPage(page)"
        [class.btn-active]="page === pagination.page"
        class="join-item btn btn-sm">
        {{ page }}
      </button>
      
      <button
        (click)="goToPage(pagination.page + 1)"
        [disabled]="pagination.page >= pagination.pages"
        class="join-item btn btn-sm">
        Next
      </button>
    </div>
  </div>

  <!-- Pagination Info -->
  <div *ngIf="!loading && !error" class="text-center text-sm text-gray-600 mt-4">
    Showing {{ (pagination.page - 1) * pagination.limit + 1 }} to 
    {{ Math.min(pagination.page * pagination.limit, pagination.total) }} of 
    {{ pagination.total }} users
  </div>
</div>

<!-- Add User Modal -->
<div *ngIf="showAddForm" class="modal modal-open">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Add New User</h3>
    
    <form (ngSubmit)="addUser()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Name</span>
        </label>
        <input
          type="text"
          [(ngModel)]="newUser.name"
          name="name"
          class="input input-bordered"
          required>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Email</span>
        </label>
        <input
          type="email"
          [(ngModel)]="newUser.email"
          name="email"
          class="input input-bordered"
          required>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Password</span>
        </label>
        <input
          type="password"
          [(ngModel)]="newUser.password"
          name="password"
          class="input input-bordered"
          required>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Role</span>
        </label>
        <select
          [(ngModel)]="newUser.role"
          name="role"
          class="select select-bordered">
          <option value="agent">Agent</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="form-control">
      </div>

      <div class="modal-action">
        <button
          type="button"
          (click)="cancelAdd()"
          class="btn btn-ghost">
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary">
          Add User
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit User Modal -->
<div *ngIf="showEditForm && editingUser" class="modal modal-open">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Edit User</h3>
    
    <form (ngSubmit)="updateUser()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Name</span>
        </label>
        <input
          type="text"
          [(ngModel)]="userUpdate.name"
          name="name"
          class="input input-bordered"
          required>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Email</span>
        </label>
        <input
          type="email"
          [(ngModel)]="userUpdate.email"
          name="email"
          class="input input-bordered"
          required>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Role</span>
        </label>
        <select
          [(ngModel)]="userUpdate.role"
          name="role"
          class="select select-bordered">
          <option value="customer">Customer</option>
          <option value="agent">Agent</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="form-control">
      </div>

      <div class="modal-action">
        <button
          type="button"
          (click)="cancelEdit()"
          class="btn btn-ghost">
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary">
          Update User
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Policy Assignment Modal -->
<div *ngIf="showPolicyAssignmentModal" class="modal modal-open">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Assign Policy to {{ selectedUserForAssignment?.name }}</h3>
    
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text">Select Policy</span>
      </label>
      <select 
        [(ngModel)]="selectedPolicyId" 
        class="select select-bordered w-full">
        <option value="">Choose a policy...</option>
        <option *ngFor="let policy of availablePolicies" [value]="policy._id">
          {{ policy.title }} - {{ policy.code }} (₹{{ policy.premium }}/month)
        </option>
      </select>
    </div>

    <div *ngIf="availablePolicies.length === 0" class="text-center text-gray-500 py-4">
      No policies available for assignment
    </div>

    <div class="modal-action">
      <button 
        (click)="closePolicyAssignmentModal()" 
        class="btn btn-ghost">
        Cancel
      </button>
      <button 
        (click)="assignSelectedPolicy()" 
        [disabled]="!selectedPolicyId"
        class="btn btn-primary">
        Assign Policy
      </button>
    </div>
  </div>
</div>

<!-- Claim Assignment Modal -->
<div *ngIf="showClaimAssignmentModal" class="modal modal-open">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Assign Claim to {{ selectedUserForAssignment?.name }}</h3>
    
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text">Select Claim</span>
      </label>
      <select 
        [(ngModel)]="selectedClaimId" 
        class="select select-bordered w-full">
        <option value="">Choose a claim...</option>
        <option *ngFor="let claim of availableClaims" [value]="claim._id">
          Claim #{{ claim._id.substring(0, 8) }} - ₹{{ claim.amountClaimed }} - {{ claim.description.substring(0, 50) }}...
        </option>
      </select>
    </div>

    <div *ngIf="availableClaims.length === 0" class="text-center text-gray-500 py-4">
      No unassigned claims available
    </div>

    <div class="modal-action">
      <button 
        (click)="closeClaimAssignmentModal()" 
        class="btn btn-ghost">
        Cancel
      </button>
      <button 
        (click)="assignSelectedClaim()" 
        [disabled]="!selectedClaimId"
        class="btn btn-primary">
        Assign Claim
      </button>
    </div>
  </div>
</div>
